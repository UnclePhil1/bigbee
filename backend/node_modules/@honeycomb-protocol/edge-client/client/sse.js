"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createClient = createClient;
const generated_1 = require("./generated");
const graphql_1 = require("graphql");
const types_1 = require("./types");
const graphql_sse_1 = require("graphql-sse");
function createClient(url) {
    const sse = (0, graphql_sse_1.createClient)({
        url,
    });
    const requester = async (query, variables, options) => {
        const iterator = sse.iterate({
            query: (0, graphql_1.print)(query),
            variables: variables,
        });
        const { value } = await iterator.next();
        if (value.error) {
            throw value.error;
        }
        const data = value.data;
        options?.streamCallback && options?.streamCallback(data);
        let hasNext = value.hasNext;
        while (hasNext) {
            const { value } = await iterator.next();
            if (value.error) {
                throw value.error;
            }
            if (value.incremental) {
                let ref = data;
                let refIdx = value.incremental[0].path.pop();
                for (let path of value.incremental[0].path) {
                    switch (typeof path) {
                        case "string":
                            ref = ref[path];
                            break;
                    }
                }
                ref[refIdx] = value.incremental[0].items[0];
                options?.streamCallback &&
                    options?.streamCallback(value.incremental[0].items[0]);
            }
            hasNext = value.hasNext;
        }
        return data;
    };
    const SDK = (0, generated_1.getSdk)(requester);
    return types_1.sseDependendFuncs.reduce((acc, k) => ({ ...acc, [k]: SDK[k] }), {});
}
//# sourceMappingURL=sse.js.map